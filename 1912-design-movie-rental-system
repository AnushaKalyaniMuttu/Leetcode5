import java.util.*;

class MovieRentingSystem {

    static class Movie {
        int shop;
        int movie;
        int price;

        Movie(int shop, int movie, int price) {
            this.shop = shop;
            this.movie = movie;
            this.price = price;
        }
    }

    // price → shop → movie
    private final Comparator<Movie> comp = (a, b) -> {
        if (a.price != b.price) return a.price - b.price;
        if (a.shop != b.shop) return a.shop - b.shop;
        return a.movie - b.movie;
    };

    // movieId -> available movies
    private Map<Integer, TreeSet<Movie>> available;

    // rented movies (global)
    private TreeSet<Movie> rented;

    // (shop#movie) -> Movie
    private Map<String, Movie> lookup;

    public MovieRentingSystem(int n, int[][] entries) {
        available = new HashMap<>();
        rented = new TreeSet<>(comp);
        lookup = new HashMap<>();

        for (int[] e : entries) {
            int shop = e[0], movie = e[1], price = e[2];
            Movie m = new Movie(shop, movie, price);

            available
                .computeIfAbsent(movie, k -> new TreeSet<>(comp))
                .add(m);

            lookup.put(key(shop, movie), m);
        }
    }

    public List<Integer> search(int movie) {
        List<Integer> res = new ArrayList<>();
        if (!available.containsKey(movie)) return res;

        Iterator<Movie> it = available.get(movie).iterator();
        while (it.hasNext() && res.size() < 5) {
            res.add(it.next().shop);
        }
        return res;
    }

    public void rent(int shop, int movie) {
        Movie m = lookup.get(key(shop, movie));
        available.get(movie).remove(m);
        rented.add(m);
    }

    public void drop(int shop, int movie) {
        Movie m = lookup.get(key(shop, movie));
        rented.remove(m);
        available.get(movie).add(m);
    }

    public List<List<Integer>> report() {
        List<List<Integer>> res = new ArrayList<>();
        Iterator<Movie> it = rented.iterator();
        while (it.hasNext() && res.size() < 5) {
            Movie m = it.next();
            res.add(Arrays.asList(m.shop, m.movie));
        }
        return res;
    }

    private String key(int shop, int movie) {
        return shop + "#" + movie;
    }
}
