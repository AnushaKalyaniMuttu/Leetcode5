WITH all_calls AS (
    SELECT 
        caller_id AS user_id,
        recipient_id AS other_id,
        DATE(call_time) AS call_date,
        call_time
    FROM Calls
    
    UNION ALL
    
    SELECT 
        recipient_id AS user_id,
        caller_id AS other_id,
        DATE(call_time) AS call_date,
        call_time
    FROM Calls
),

ranked_calls AS (
    SELECT 
        user_id,
        call_date,
        other_id,
        ROW_NUMBER() OVER (PARTITION BY user_id, call_date ORDER BY call_time) AS first_rank,
        ROW_NUMBER() OVER (PARTITION BY user_id, call_date ORDER BY call_time DESC) AS last_rank
    FROM all_calls
)

SELECT DISTINCT user_id
FROM ranked_calls
WHERE first_rank = 1 OR last_rank = 1
GROUP BY user_id, call_date
HAVING 
    MAX(CASE WHEN first_rank = 1 THEN other_id END) =
    MAX(CASE WHEN last_rank = 1 THEN other_id END);
